rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ========================================
    // è¼”åŠ©å‡½æ•¸
    // ========================================
    
    // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦å·²ç™»å…¥
    function isSignedIn() {
      return request.auth != null;
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºç®¡ç†å“¡
    // æš«æ™‚å…è¨±æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶ä½œç‚ºç®¡ç†å“¡ï¼ˆå› ç‚º Web Admin ä½¿ç”¨ Supabase Authï¼‰
    // TODO: æ”¹ç”¨ Custom Claims æˆ–å…¶ä»–æ›´å®‰å…¨çš„é©—è­‰æ–¹å¼
    function isAdmin() {
      return isSignedIn();
    }
    
    // æª¢æŸ¥æ˜¯å¦ç‚ºå°è©±çš„æ“æœ‰è€…
    function isChatOwner(chatId) {
      return isSignedIn() && 
             chatId == 'cs_' + request.auth.uid;
    }
    
    // ========================================
    // ç”¨æˆ¶é›†åˆï¼ˆéœ€è¦è®€å–æ¬Šé™ä»¥ç²å–ç”¨æˆ¶è³‡è¨Šï¼‰
    // ========================================
    
    match /users/{userId} {
      // å…è¨±ç”¨æˆ¶è®€å–è‡ªå·±çš„è³‡æ–™
      allow read: if isSignedIn() && request.auth.uid == userId;
      
      // å…è¨±ç®¡ç†å“¡è®€å–æ‰€æœ‰ç”¨æˆ¶è³‡æ–™
      allow read: if isAdmin();
      
      // å…è¨±ç”¨æˆ¶å¯«å…¥è‡ªå·±çš„è³‡æ–™
      allow write: if isSignedIn() && request.auth.uid == userId;
    }
    
    // ========================================
    // å®¢æœå°è©±é›†åˆ
    // ========================================
    
    match /customer_service_chats/{chatId} {
      // å…è¨±ç”¨æˆ¶è®€å–å’Œå¯«å…¥è‡ªå·±çš„å®¢æœå°è©±
      allow read, write: if isChatOwner(chatId);
      
      // å…è¨±ç®¡ç†å“¡è®€å–æ‰€æœ‰å®¢æœå°è©±
      allow read: if isAdmin();
      
      // å…è¨±ç®¡ç†å“¡æ›´æ–°å®¢æœå°è©±ï¼ˆä¾‹å¦‚ï¼šæ›´æ–° lastMessageï¼‰
      allow update: if isAdmin();
      
      // ========================================
      // å®¢æœè¨Šæ¯å­é›†åˆ
      // ========================================
      
      match /messages/{messageId} {
        // å…è¨±ç”¨æˆ¶è®€å–å’Œå¯«å…¥è‡ªå·±çš„å®¢æœå°è©±è¨Šæ¯
        allow read, create: if isChatOwner(chatId);
        
        // å…è¨±ç®¡ç†å“¡è®€å–å’Œå¯«å…¥æ‰€æœ‰å®¢æœè¨Šæ¯
        allow read, create: if isAdmin();
        
        // å…è¨±è¨Šæ¯ç™¼é€è€…æ›´æ–°è‡ªå·±çš„è¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šæ¨™è¨˜ç‚ºå·²è®€ï¼‰
        allow update: if isSignedIn() && 
                         (request.auth.uid == resource.data.senderId || isAdmin());
      }
    }
    
    // ========================================
    // ç¾æœ‰çš„èŠå¤©å®¤è¦å‰‡ï¼ˆè¨‚å–®ç›¸é—œèŠå¤©ï¼‰
    // è«‹ä¿ç•™æ‚¨åŸæœ‰çš„è¦å‰‡ï¼Œä»¥ä¸‹æ˜¯ç¤ºä¾‹
    // ========================================
    
    match /chat_rooms/{bookingId} {
      // ğŸ”’ ä¿®å¾©ï¼šåªå…è¨±èŠå¤©å®¤çš„å®¢æˆ¶æˆ–å¸æ©Ÿè®€å–å’Œæ›´æ–°èŠå¤©å®¤
      // è®€å–æ¬Šé™ï¼šåªèƒ½è®€å–è‡ªå·±åƒèˆ‡çš„èŠå¤©å®¤
      allow read: if isSignedIn() &&
        (
          // æ–‡æª”ä¸å­˜åœ¨æ™‚å…è¨±è®€å–ï¼ˆæœƒè¿”å› nullï¼‰
          !exists(/databases/$(database)/documents/chat_rooms/$(bookingId))
          ||
          // æ–‡æª”å­˜åœ¨æ™‚æª¢æŸ¥æ˜¯å¦ç‚ºç”¨æˆ¶è‡ªå·±çš„èŠå¤©å®¤
          (resource.data.customerId == request.auth.uid ||
           resource.data.driverId == request.auth.uid)
        );

      // æ›´æ–°æ¬Šé™ï¼šåªèƒ½æ›´æ–°ç‰¹å®šæ¬„ä½ï¼ˆlastMessage, lastMessageTime, unreadCountï¼‰
      allow update: if isSignedIn() &&
        (resource.data.customerId == request.auth.uid ||
         resource.data.driverId == request.auth.uid) &&
        request.resource.data.diff(resource.data).affectedKeys()
          .hasOnly(['lastMessage', 'lastMessageTime', 'customerUnreadCount', 'driverUnreadCount', 'updatedAt']);

      // ç¦æ­¢å®¢æˆ¶ç«¯å‰µå»ºæˆ–åˆªé™¤èŠå¤©å®¤ï¼ˆç”± Backend API å‰µå»ºï¼‰
      allow create, delete: if false;

      match /messages/{messageId} {
        // è®€å–æ¬Šé™ï¼šåªèƒ½è®€å–è‡ªå·±åƒèˆ‡çš„èŠå¤©å®¤çš„è¨Šæ¯
        allow read: if isSignedIn() &&
          (
            // æ–‡æª”ä¸å­˜åœ¨æ™‚å…è¨±è®€å–ï¼ˆæœƒè¿”å› nullï¼‰
            !exists(/databases/$(database)/documents/chat_rooms/$(bookingId))
            ||
            // æ–‡æª”å­˜åœ¨æ™‚æª¢æŸ¥æ˜¯å¦ç‚ºç”¨æˆ¶è‡ªå·±çš„èŠå¤©å®¤
            (get(/databases/$(database)/documents/chat_rooms/$(bookingId)).data.customerId == request.auth.uid ||
             get(/databases/$(database)/documents/chat_rooms/$(bookingId)).data.driverId == request.auth.uid)
          );

        // å‰µå»ºæ¬Šé™ï¼šåªèƒ½åœ¨è‡ªå·±åƒèˆ‡çš„èŠå¤©å®¤ä¸­å‰µå»ºè¨Šæ¯
        allow create: if isSignedIn() &&
          (get(/databases/$(database)/documents/chat_rooms/$(bookingId)).data.customerId == request.auth.uid ||
           get(/databases/$(database)/documents/chat_rooms/$(bookingId)).data.driverId == request.auth.uid) &&
          request.resource.data.senderId == request.auth.uid;

        // ç¦æ­¢æ›´æ–°å’Œåˆªé™¤è¨Šæ¯
        allow update, delete: if false;
      }
    }
    
    // ========================================
    // å…¶ä»–å¯èƒ½çš„é›†åˆï¼ˆæ ¹æ“šéœ€è¦èª¿æ•´ï¼‰
    // ========================================

    // è¨‚å–®å³æ™‚é¡åƒé›†åˆï¼ˆå¾ Supabase å–®å‘é¡åƒï¼ŒRead-Onlyï¼‰
    // ç”¨æ–¼å¸æ©Ÿç«¯å’Œå®¢æˆ¶ç«¯å³æ™‚ç•«é¢å±•ç¤º
    match /orders_rt/{orderId} {
      // å…è¨±æ‰€æœ‰å·²ç™»å…¥ç”¨æˆ¶è®€å–è¨‚å–®ï¼ˆç”¨æ–¼æŸ¥è©¢ï¼‰
      // æ³¨æ„ï¼šé€™æ˜¯æš«æ™‚æ€§è§£æ±ºæ–¹æ¡ˆï¼Œå› ç‚º Firestore æŸ¥è©¢éœ€è¦å…ˆè®€å–æ–‡æª”æ‰èƒ½æª¢æŸ¥ resource.data
      // å¯¦éš›çš„è³‡æ–™éæ¿¾ç”±æ‡‰ç”¨å±¤çš„æŸ¥è©¢æ¢ä»¶ï¼ˆwhere driverId/customerIdï¼‰ä¾†ä¿è­‰
      allow read: if isSignedIn();

      // å…è¨±ç®¡ç†å“¡è®€å–æ‰€æœ‰è¨‚å–®
      allow read: if isAdmin();

      // ç¦æ­¢æ‰€æœ‰å¯«å…¥æ“ä½œï¼ˆæ­¤é›†åˆç”±å¾Œç«¯åŒæ­¥ï¼Œä¸å…è¨±å®¢æˆ¶ç«¯å¯«å…¥ï¼‰
      allow write: if false;
    }

    // ä½ç½®è¿½è¹¤
    match /driver_locations/{driverId} {
      allow read: if isSignedIn();
      allow write: if isSignedIn() && request.auth.uid == driverId;
    }

    // æ¨é€é€šçŸ¥ tokens
    match /fcm_tokens/{userId} {
      allow read, write: if isSignedIn() && request.auth.uid == userId;
    }
  }
}

